{% extends '@KontrolgruppenCore/process/main.html.twig' %}

{% macro printRevenueEntryRow(revenueEntry) %}
    <tr class="revenue-entry">
        <td class="service">{{ form_widget(revenueEntry.service) }}</td>
        <td class="type"><span style="display: none">{{ form_widget(revenueEntry.type) }}</span><span class="text"></span></td>
        <td class="amount">{{ form_widget(revenueEntry.amount) }}</td>
        <td class="future-savings"><span class="future-savings-select">{{ form_widget(revenueEntry.futureSavingsType) }}</span></td>
        <td>
        </td>
    </tr>
{% endmacro %}
{% import _self as formMacros %}

{% block title %}{{ 'economy.show.title'|trans }}{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-12">
            <h1 class="float-left">{{ 'economy.show.title'|trans }}</h1>

            {% if canEdit %}
                <span data-toggle="collapse" data-target="#economyEntryNew" aria-expanded="{{ collapse_economy_entry_form ? 'false' : 'true' }}">
                    <button data-toggle="button" aria-pressed="{{ collapse_economy_entry_form ? 'false' : 'true' }}"
                            class="btn btn-success btn-lg float-right">
                        <span class="show">{{ 'economy.actions.create'|trans }}</span>
                        <span class="hide">{{ 'journal_entry.actions.hide'|trans }}</span>
                    </button>
                </span>
            {% endif %}
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            {% if process.completedAt %}
                <div class="alert alert-warning">{{ 'process.completed_message'|trans }}</div>
            {% endif %}

            {% if canEdit %}
                <div class="col-12 collapse {{ collapse_economy_entry_form ? '' : 'show' }}" id="economyEntryNew">
                    <div class="bg-light border-bottom p-3 mb-3">
                        {# This consists of two forms #}

                        {# This form decides which economy entry type is created #}
                        {{ form_start(economy_entry_form) }}
                        {{ form_widget(economy_entry_form) }}
                        {{ form_end(economy_entry_form) }}

                        <div id="js-economy-form-spinner" class="spinner-border spinner-border-sm" style="display: none" role="status">
                            <span class="sr-only">{{ 'search.loading_results'|trans }}</span>
                        </div>

                        {# When an economy entry type has been chosen, this entity form becomes added #}
                        {% if form is defined %}
                            {% include '@KontrolgruppenCore/economy_entry/_form.html.twig' %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <h2>{{ 'economy.headline.economy_entries_service'|trans }}</h2>
    {% include '@KontrolgruppenCore/economy_entry/_economy_entry_service_table.html.twig' with {economyEntries: economyEntriesService} %}

    <h2>{{ 'economy.headline.economy_entries_income'|trans }}</h2>
    {% include '@KontrolgruppenCore/economy_entry/_economy_entry_income_table.html.twig' with {economyEntries: economyEntriesIncome} %}

    <h2>{{ 'economy.headline.economy_entries_account'|trans }}</h2>
    {% include '@KontrolgruppenCore/economy_entry/_economy_entry_base_table.html.twig' with {economyEntries: economyEntriesAccount} %}

    <h2>{{ 'economy.headline.revenue_calculation'|trans }}</h2>
    <div class="table-responsive">
        {{ form_start(revenueForm) }}
            {% for service in services %}
                <div id="service-{{ service.id }}">
                    <h2 class="float-left text-muted">{{ service.name }}</h2>
                    <div class="float-right">
                        <button data-service-id="{{ service.id }}" class="js-add-repayment btn btn-sm btn-outline-info m-2">{{ 'economy.revenue.add_revenue_repayment'|trans }}</button>
                        <button data-service-id="{{ service.id }}" class="js-add-future-savings btn btn-sm btn-outline-success m-2">{{ 'economy.revenue.add_future_savings'|trans }}</button>
                    </div>
                </div>

                <table id="revenue-calculation-table-{{ service.id }}" class="table table-striped table-hover table-borderless thead-light">
                    <tbody id="service-elements-{{ service.id }}">
                    </tbody>
                </table>
            {% endfor %}

            {# Default table where new entries are created. The javascript moves the elements to the correct service tables #}
            <div id="revenue-lost-entries" style="display: none;">
                <h2 class="text-muted">{{ 'economy.revenue.lost_entries'|trans }}</h2>
                <table id="revenue-calculation-table" class="table table-striped table-hover table-borderless thead-light">
                    <tbody class="revenue_entries" data-prototype="{{ formMacros.printRevenueEntryRow(revenueForm.revenueEntries.vars.prototype)|e('html_attr') }}">
                    {% for revenueEntryForm in revenueForm.revenueEntries %}
                        {{ formMacros.printRevenueEntryRow(revenueEntryForm) }}
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            {{ form_widget(revenueForm.save, { 'label': 'economy.revenue.save'|trans, 'class': 'btn btn-primary float-right' }) }}
        {{ form_end(revenueForm) }}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('addEconomyEntry') }}

    {#{{ encore_entry_script_tags('prepareRevenueCalculation') }}#}

    {% if canEdit %}
        <script type="text/javascript">
            var $defaultHolder;

            // Add buttons to form when the page is loaded.
            $(document).ready(function() {
                // Get the element that holds the collection.
                $defaultHolder = $('tbody.revenue_entries');

                // Add "remove" buttons to existing entries.
                $defaultHolder.find('tr').each(function() {
                    addRemoveRevenueEntryButton($(this));
                });

                // Setup index as number of entries. The index is used to name the forms.
                $defaultHolder.data('index', $defaultHolder.find(':input').length);

                // When add button is pressed, add a new form element.
                $('.js-add-future-savings').on('click', function(event) {
                    event.stopPropagation();
                    event.preventDefault();

                    var serviceId = $(this).data('service-id');
                    addRevenueEntryForm($defaultHolder, $('#revenue-calculation-table-' + serviceId), serviceId, 'FUTURE_SAVINGS');
                });
                $('.js-add-repayment').on('click', function(event) {
                    event.stopPropagation();
                    event.preventDefault();

                    var serviceId = $(this).data('service-id');
                    addRevenueEntryForm($defaultHolder, $('#revenue-calculation-table-' + serviceId), serviceId, 'REPAYMENT');
                });

                // Move entries from default holder table to service tables.
                $defaultHolder.find('tr.revenue-entry').each(function () {
                    var $element = $(this);
                    var selectedServiceId = $element.find('option:selected').val();
                    var $serviceElement = $('#service-elements-'+selectedServiceId);

                    if ($serviceElement.length === 1) {
                        $element.find('.service').hide();
                        if ($element.find('.type select').val() === 'REPAYMENT') {
                            $element.find('.future-savings-select').hide();
                        }
                        $element.find('.type .text').text($element.find('.type option:selected').text());

                        $serviceElement.append($element.detach());
                    }
                    else {
                        $('#revenue-lost-entries').show();
                    }
                })
            });

            /**
             * Add remove revenue entry button.
             */
            function addRemoveRevenueEntryButton($element) {
                var $removeFormButton = $('<button class="btn btn-sm btn-danger mt-3 mb-3" type="button">Remove</button>');
                $element.append($removeFormButton);

                // When the button is pressed, remove the element.
                $removeFormButton.on('click', function() {
                    $element.remove();
                });
            }

            /**
             * Add a new revenue entry form.
             *
             * @param $defaultHolder
             *   The default holder, that also has the form prototype
             * @param $holder
             *   The holder to add the new form element to
             * @param service
             *   The service to add the revenue entry to
             * @param type
             *   The type, either 'FUTURE_SAVINGS' or 'REPAYMENT'
             */
            function addRevenueEntryForm($defaultHolder, $holder, service, type) {
                // Get the data-prototype for revenue entries.
                var prototype = $defaultHolder.data('prototype');

                // Get the new index.
                var index = $defaultHolder.data('index');

                var newForm = prototype;

                // Replace '__name__' in the prototype's HTML to instead be a number based on how many items we have.
                newForm = newForm.replace(/__name__/g, index);

                // Increase the index with one for the next item.
                $defaultHolder.data('index', index + 1);

                // Display the form in the page.
                var $element = $(newForm);

                $element.find('.service select option[value="' + service + '"]').prop("selected", "selected");
                $element.find('.service').hide();
                $element.find('.type select option[value="' + type + '"]').prop("selected", "selected");
                $element.find('.type .text').text($element.find('.type option:selected').text());

                if (type === 'REPAYMENT') {
                    $element.find('.future-savings-select').hide();
                }

                $holder.append($element);
                addRemoveRevenueEntryButton($element);
            }
        </script>
    {% endif %}
{% endblock %}
